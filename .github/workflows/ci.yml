name: ExoRust CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  # ============================================================================
  # Build Job
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Build kernel
      run: cargo build --target x86_64-rany_os.json
    
    - name: Build release
      run: cargo build --target x86_64-rany_os.json --release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-binary
        path: target/x86_64-rany_os/debug/RanyOS
        retention-days: 7

  # ============================================================================
  # Lint Job
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt, clippy, rust-src
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Clippy lints
      run: cargo clippy --target x86_64-rany_os.json -- -D warnings
      continue-on-error: true  # no_std環境では一部警告が出る可能性

  # ============================================================================
  # Documentation Job
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src
    
    - name: Build docs
      run: cargo doc --target x86_64-rany_os.json --no-deps
      continue-on-error: true  # no_std環境のdoc生成
    
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: target/x86_64-rany_os/doc
        retention-days: 7

  # ============================================================================
  # QEMU Test Job
  # ============================================================================
  qemu-test:
    name: QEMU Boot Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview
    
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86
    
    - name: Build kernel
      run: cargo build --target x86_64-rany_os.json
    
    - name: Run QEMU test
      run: |
        timeout 30s qemu-system-x86_64 \
          -machine q35 \
          -cpu qemu64 \
          -smp 2 \
          -m 512M \
          -kernel target/x86_64-rany_os/debug/RanyOS \
          -serial stdio \
          -display none \
          -device isa-debug-exit,iobase=0xf4,iosize=0x04 \
          -no-reboot \
          2>&1 || true
      continue-on-error: true  # bootloaderが無い場合は失敗する可能性

  # ============================================================================
  # Code Quality Job
  # ============================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Count lines of code
      run: |
        echo "=== Source Files ==="
        find src -name '*.rs' | wc -l
        echo "=== Lines of Code ==="
        find src -name '*.rs' -exec cat {} \; | wc -l
    
    - name: Count unsafe blocks
      run: |
        echo "=== Unsafe Blocks ==="
        grep -r "unsafe" src --include="*.rs" | wc -l || echo "0"
    
    - name: Check for TODO/FIXME
      run: |
        echo "=== TODOs ==="
        grep -rn "TODO\|FIXME" src --include="*.rs" || echo "None found"

  # ============================================================================
  # Security Audit Job
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Run security audit
      run: cargo audit
      continue-on-error: true  # no_stdの依存関係は制限されている

  # ============================================================================
  # Release Job
  # ============================================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build, lint, qemu-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview
    
    - name: Build release
      run: cargo build --target x86_64-rany_os.json --release
    
    - name: Get version
      id: version
      run: echo "version=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
    
    - name: Create release archive
      run: |
        mkdir -p release
        cp target/x86_64-rany_os/release/RanyOS release/ 2>/dev/null || true
        cp target/x86_64-rany_os/debug/RanyOS release/RanyOS-debug 2>/dev/null || true
        cp README.md release/
        cp docs/API_REFERENCE.md release/
        cp docs/ARCHITECTURE.md release/
        tar -czvf exorust-${{ steps.version.outputs.version }}.tar.gz release/
    
    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: exorust-release
        path: exorust-*.tar.gz
        retention-days: 30
